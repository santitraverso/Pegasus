@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="text-center">
    <h1 class="display-4">Pegasus</h1>
    <p>Bienvenidos</p>
</div>

<h1>Login con Google</h1>
<button id="loginGoogleBtn">Iniciar sesión con Google</button>
<div id="userEmailDisplay"></div>

<script>

    //document.getElementById('loginGoogleBtn').addEventListener('click', async function () {
    //    // Llama a tu backend para iniciar el proceso de autenticación
    //    //const response = await fetch('https://localhost:7130/Account/Login?returnUrl=https://localhost:7063/signin-google');
    //    const response = await fetch('https://localhost:7130/Account/Login');

    //    if (response.ok) {
    //        const userData = await response.json();
    //        // Guardar el usuario en la sesión
    //        sessionStorage.setItem('user', JSON.stringify(userData));
    //        console.log('Usuario autenticado:', userData);
    //        // Redirige a donde desees
    //        window.location.href = 'https://localhost:7063'; // o cualquier otra página
    //    } else {
    //        console.error('Error en la solicitud de autenticación:', response.statusText);
    //    }
    //});

    // Función para iniciar el proceso de autenticación al hacer clic en el botón de Google
    document.getElementById('loginGoogleBtn').addEventListener('click', function () {
        // Definir la URL de retorno
        const returnUrl = 'https://localhost:7063';
        // Construir la URL de inicio de sesión
        const loginUrl = `https://localhost:7130/Account/Login?returnUrl=${encodeURIComponent(returnUrl)}`;
        // Redirigir a la URL de inicio de sesión
        window.location.href = loginUrl;
    });

    // Función para obtener parámetros de consulta de la URL
    function getQueryParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const pairs = queryString.split("&");

        pairs.forEach(pair => {
            const [key, value] = pair.split("=");
            params[decodeURIComponent(key)] = decodeURIComponent(value);
        });

        return params;
    }

    // Función para guardar los datos del usuario en sessionStorage
    function storeUserData() {
        const userData = getQueryParams();

        // Guardar en sessionStorage si hay datos de usuario
        if (userData.email) {
            sessionStorage.setItem('userEmail', userData.email);
            sessionStorage.setItem('userPerfil', userData.perfil);

            console.log('Datos del usuario:', userData.email, userData.perfil);

            // Reemplazar la URL sin los parámetros
            history.replaceState(null, '', window.location.pathname);
        }
    }

    // Función para mostrar el email del usuario en un elemento HTML
    function displayUserEmail() {
        const userEmail = sessionStorage.getItem('userEmail');
        if (userEmail) {
            document.getElementById('userEmailDisplay').textContent = `Bienvenido, ${userEmail}`;
        }
    }

    // Al cargar la página, almacenar los datos del usuario y mostrar el email
    window.onload = function () {
        storeUserData();
        displayUserEmail();
    };
</script>
