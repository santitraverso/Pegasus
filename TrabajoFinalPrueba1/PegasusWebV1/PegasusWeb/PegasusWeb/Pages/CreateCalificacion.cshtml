@page
@using PegasusWeb.Entities
@model PegasusWeb.Pages.CreateCalificacionModel
@{
    var esEdicion = Model.Alumno.Usuario is not null ? Model.Alumno.Usuario.Calificaciones.Count > 0: false;
    var titulo = esEdicion ? "Editar Calificacion" : "Cargar Nueva Calificacion";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Index</title>
</head>
<body>
    <h4 class="centrado">@titulo</h4>
    <br />
    <form method="post">
        <input type="hidden" name="alumno" value="@Model.Alumno.Id_Usuario" />
        <input type="hidden" name="materia" value="@Model.Alumno.Id_Materia" />
    <div class="container">
        <table id="tablaAlumnos" class="table">
            <thead>
                <tr>
                    <th>Apellido</th>
                    <th>Nombre</th>
                    <th>Calificaciones</th>
                </tr>
            </thead>
            <tbody>
                    <tr>
                        <td>@Model.Alumno.Usuario.Apellido</td>
                        <td>@Model.Alumno.Usuario.Nombre</td>
                        <td>
                            
                                <table class="nested-table">
                                @if (Model.Alumno.Usuario.Calificaciones.Count > 0)
                                {
                                    var index = 0;
                                    @foreach (var calificacion in Model.Alumno.Usuario.Calificaciones)
                                    {
                                        <tr id="calificacion-@index">
                                            <td>Nota @(index+1)</td>
                                            <td style="display: flex; align-items: center;">
                                                <input type="number" asp-for="@calificacion.Calificacion" class="form-control" name="Calificaciones[@index].Calificacion" required min="1" max="10" />
                                                <img src="~/img/eliminar.png" class="icon" alt="" onclick="eliminarCalificacion(@index, @calificacion.Id)">
                                            </td>
                                            <input type="hidden" name="Calificaciones[@index].Id" value="@calificacion.Id" />
                                        </tr>
                                        
                                        index++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td>Nota</td>
                                        <td><input type="number" value="" class="form-control" name="Calificaciones[0].Calificacion" required min="1" max="10" /></td>
                                        <input type="hidden" name="Calificaciones[0].Id" value="0" />
                                    </tr>
                                }
                                </table>
                        </td>
                        
                    </tr>
                
            </tbody>
        </table>
    </div>
        <button type="submit" class="btn btn-primary">Guardar</button>
        <input type="hidden" id="calificacionesEliminadas" name="CalificacionesEliminadas" value="" />
    </form>
</body>
</html>
@section scripts{
    <script>
        function eliminarCalificacion(index, id) {
            if (confirm('¿Estás seguro de que deseas eliminar esta calificación?')) {
                const fila = document.getElementById(`calificacion-${index}`);
                if (fila) {
                    fila.remove();

                    // Guardar el ID de la calificación eliminada
                    let eliminadas = document.getElementById('calificacionesEliminadas').value;
                    eliminadas = eliminadas ? eliminadas.split(',') : [];
                    eliminadas.push(id);
                    document.getElementById('calificacionesEliminadas').value = eliminadas.join(',');
                }
            }
        }
    </script>
}
